name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    # Build step removed - build locally and commit public/ folder instead
    
    - name: Deploy Changed Domains
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        DOMAINS="${{ steps.changes.outputs.changed_domains }}"
        
        if [ "$DOMAINS" == "none" ]; then
          echo "No domains to deploy"
          exit 0
        fi
        
        sudo apt-get update -qq && sudo apt-get install -y lftp
        
        # Create .netrc file to handle credentials securely (avoids special character issues)
        printf "machine %s\nlogin %s\npassword %s\n" "$FTP_HOST" "$FTP_USER" "$FTP_PASS" > ~/.netrc
        chmod 600 ~/.netrc
        
        if [ "$DOMAINS" == "all" ]; then
          DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
        else
          DEPLOY_LIST="$DOMAINS"
        fi
        
        for domain in $DEPLOY_LIST; do
          [[ ! -d public/$domain ]] && continue
          cfg=config/$domain/hugo.toml
          [[ ! -f $cfg ]] && continue
          
          url=$(grep baseURL $cfg | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
          clean=$(echo $url | sed 's|https\?://||;s|www\.||;s|/.*||')
          
          echo "Deploying $domain to $clean"
          
          # Upload folder contents (not folder itself) with --delete-first to remove old files safely
          # --delete-first: delete files before transferring (safer, doesn't fail on missing files)
          # --only-newer: only upload files that are newer
          # --ignore-time: ignore time when deciding which files to upload
          # Credentials read automatically from ~/.netrc
          lftp -c "set ssl:verify-certificate no; set ftp:ssl-allow yes; set net:timeout 10; set net:max-retries 2; set ftp:use-feat no; open $FTP_HOST; mirror -Rev --delete-first --only-newer --parallel=2 --verbose=0 public/$domain/ /domains/$clean/public_html/ || echo 'Deployment completed with warnings'; bye"
        done
        
        # Clean up credentials file
        rm -f ~/.netrc
