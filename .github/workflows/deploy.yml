name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      domain:
        description: 'Deploy specific domain only (e.g., badcreditloanspecialist) or leave empty for all'
        required: false
        type: string
      force_all:
        description: 'Force deploy all domains (overrides changed-domain detection)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Fix localhost URLs in public folder
      run: |
        echo "🔧 Replacing localhost URLs with production domains..."
        for domain in $(ls -d config/*/ 2>/dev/null | xargs -n1 basename | grep -v '^_default$'); do
          cfg="config/$domain/hugo.toml"
          if [ -f "$cfg" ]; then
            url=$(grep baseURL "$cfg" | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
            if [ -n "$url" ]; then
              echo "  Fixing $domain: localhost -> $url"
              find "public/$domain" -type f -name "*.html" -exec sed -i "s|http://localhost:[0-9]*|$url|g" {} \;
            fi
          fi
        done
        echo "✅ localhost URLs fixed"

    - name: Deploy All Domains
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        sudo apt-get update -qq && sudo apt-get install -y lftp
        
        # Create .netrc file to handle credentials securely (avoids special character issues)
        printf "machine %s\nlogin %s\npassword %s\n" "$FTP_HOST" "$FTP_USER" "$FTP_PASS" > ~/.netrc
        chmod 600 ~/.netrc
        
        # Inputs for manual trigger
        SPECIFIC_DOMAIN="${{ github.event.inputs.domain }}"
        FORCE_ALL="${{ github.event.inputs.force_all }}"

        if [ "$FORCE_ALL" = "true" ]; then
          echo "Force deploy all domains requested"
          DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
        elif [ -n "$SPECIFIC_DOMAIN" ]; then
          if [ "$SPECIFIC_DOMAIN" = "all" ]; then
            echo "'all' specified - deploying all domains"
            DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
          else
            echo "Deploying single domain: $SPECIFIC_DOMAIN"
            DEPLOY_LIST="$SPECIFIC_DOMAIN"
          fi
        else
          # Smart deployment: only deploy domains with changed files
          echo "Detecting changed domains from git diff..."

          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" 2>/dev/null || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected - deploying all domains for first-time setup"
            DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
          else
            # Extract unique domain names from changed files
            DEPLOY_LIST=$(echo "$CHANGED_FILES" | grep -E '^(content|config|public)/' | cut -d'/' -f2 | sort -u | grep -v '^_default$' | tr '\n' ' ')

            if [ -z "$DEPLOY_LIST" ]; then
              echo "No domain-specific changes - deploying all domains"
              DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
            else
              echo "Deploying changed domains: $DEPLOY_LIST"
            fi
          fi
        fi
        
        for domain in $DEPLOY_LIST; do
          [[ ! -d public/$domain ]] && echo "Warning: public/$domain not found, skipping" && continue
          cfg=config/$domain/hugo.toml
          [[ ! -f $cfg ]] && echo "Warning: $cfg not found, skipping" && continue
          
          url=$(grep baseURL $cfg | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
          clean=$(echo $url | sed 's|https\?://||;s|www\.||;s|/.*||')
          
          echo "Deploying $domain to $clean"
          
          # Upload folder contents (not folder itself) with --delete-first to remove old files safely
          # --delete-first: delete files before transferring (safer, doesn't fail on missing files)
          # --only-newer: only upload files that are newer
          # --ignore-time: ignore time when deciding which files to upload
          # Credentials read automatically from ~/.netrc
          lftp -c "set ssl:verify-certificate no; \
                    set ftp:ssl-allow yes; \
                    set ftp:passive-mode on; \
                    set net:timeout 30; \
                    set net:max-retries 5; \
                    set net:persist-retries 2; \
                    set net:reconnect-interval-base 5; \
                    set net:reconnect-interval-max 60; \
                    set ftp:use-feat no; \
                    set dns:order inet; \
                    open $FTP_HOST; \
                    mirror -Rev --delete-first --only-newer --parallel=2 --verbose=0 public/$domain/ /domains/$clean/public_html/ || echo 'Deployment completed with warnings'; \
                    bye"
        done
        
        # Clean up credentials file
        rm -f ~/.netrc
