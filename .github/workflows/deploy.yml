name: Deploy All Domains to Hostinger

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Detect Changed Domains
      id: changed_domains
      run: |
        echo "ğŸ” Detecting which domains need to be rebuilt..."
        
        # Get list of changed files
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
        else
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "ALL")
        fi
        
        # If no git history or first push, build all
        if [ "$CHANGED_FILES" == "ALL" ]; then
          echo "build_all=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Building ALL domains (first push or no history)"
          exit 0
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo ""
        
        # Check if global files changed (layouts, themes, scripts, workflow)
        if echo "$CHANGED_FILES" | grep -qE "^(layouts/|themes/|static/|assets/|scripts/|\.github/workflows/)"; then
          echo "build_all=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Global files changed - rebuilding ALL domains"
          exit 0
        fi
        
        # Find specific domains that changed
        DOMAINS=""
        for FILE in $CHANGED_FILES; do
          # Extract domain name from path: config/DOMAIN/ or content/DOMAIN/
          if [[ "$FILE" =~ ^config/([^/]+)/ ]] || [[ "$FILE" =~ ^content/([^/]+)/ ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            # Skip _default
            if [ "$DOMAIN" != "_default" ]; then
              # Add to list if not already there
              if [[ ! " $DOMAINS " =~ " $DOMAIN " ]]; then
                DOMAINS="$DOMAINS $DOMAIN"
                echo "âœ“ Domain changed: $DOMAIN"
              fi
            fi
          fi
        done
        
        if [ -z "$DOMAINS" ]; then
          echo "build_all=false" >> $GITHUB_OUTPUT
          echo "âœ… No domain-specific changes detected"
        else
          echo "build_all=false" >> $GITHUB_OUTPUT
          echo "domains=$DOMAINS" >> $GITHUB_OUTPUT
          echo ""
          echo "ğŸ¯ Domains to build:$DOMAINS"
        fi

    - name: Build Changed Domains Only
      run: |
        if [ "${{ steps.changed_domains.outputs.build_all }}" == "true" ]; then
          echo "ğŸš€ Building ALL domains..."
          bash scripts/build-all-domains.sh
        else
          DOMAINS="${{ steps.changed_domains.outputs.domains }}"
          if [ -z "$DOMAINS" ]; then
            echo "âœ… No domains need rebuilding - skipping"
            exit 0
          fi
          
          echo "ğŸ¯ Building only changed domains: $DOMAINS"
          for DOMAIN in $DOMAINS; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—ï¸  Building: $DOMAIN"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            hugo --environment "$DOMAIN" \
                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \
                 --destination "public/$DOMAIN" \
                 --cleanDestinationDir \
                 --minify
            
            echo "âœ… $DOMAIN built successfully"
          done
        fi
    
    # Deploy ALL domains dynamically - no hardcoded domain names!
    # Automatically discovers and deploys any domain in public/ folder

    - name: Deploy All Built Domains via FTP
      run: |
        echo "ğŸš€ Starting dynamic FTP deployment..."
        echo ""
        
        # Install lftp for reliable FTP uploads
        sudo apt-get update && sudo apt-get install -y lftp
        
        DEPLOYED_COUNT=0
        SKIPPED_COUNT=0
        
        # Loop through all folders in public/
        for DOMAIN_DIR in public/*/; do
          if [ ! -d "$DOMAIN_DIR" ]; then
            continue
          fi
          
          DOMAIN_NAME=$(basename "$DOMAIN_DIR")
          
          # Skip non-domain directories (build artifacts)
          if [[ "$DOMAIN_NAME" == "blogs" ]] || [[ "$DOMAIN_NAME" == "categories" ]] || \
             [[ "$DOMAIN_NAME" == "tags" ]] || [[ "$DOMAIN_NAME" == "page" ]]; then
            echo "â­ï¸  Skipping artifact directory: $DOMAIN_NAME"
            continue
          fi
          
          # Get domain URL from config
          CONFIG_FILE="config/${DOMAIN_NAME}/hugo.toml"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âš ï¸  Skipping $DOMAIN_NAME - no config found"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          # Extract baseURL
          BASE_URL=$(grep -E "^baseURL" "$CONFIG_FILE" | head -1 | sed -E 's/^baseURL[[:space:]]*=[[:space:]]*["\x27]([^"\x27]+)["\x27].*/\1/')
          CLEAN_DOMAIN=$(echo "$BASE_URL" | sed 's|https\?://||' | sed 's|www\.||' | sed 's|/.*||')
          
          if [ -z "$CLEAN_DOMAIN" ]; then
            echo "âš ï¸  Skipping $DOMAIN_NAME - could not extract domain"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Deploying: $DOMAIN_NAME"
          echo "ğŸŒ Domain: $CLEAN_DOMAIN"
          echo "ğŸ“‚ Local: $DOMAIN_DIR"
          echo "ğŸ“ Remote: /domains/${CLEAN_DOMAIN}/public_html/"
          
          # FTP upload using lftp (handles large deployments efficiently)
          lftp -e "
            set ssl:verify-certificate no;
            set net:timeout 30;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
            mirror -Rev --delete --parallel=4 --exclude .git/ --exclude node_modules/ ${DOMAIN_DIR} /domains/${CLEAN_DOMAIN}/public_html/;
            bye
          " 2>&1
          
          if [ $? -eq 0 ]; then
            echo "âœ… $DOMAIN_NAME deployed successfully"
            DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
          else
            echo "âŒ $DOMAIN_NAME deployment failed"
          fi
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Complete"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Deployed: $DEPLOYED_COUNT domains"
        if [ $SKIPPED_COUNT -gt 0 ]; then
          echo "âš ï¸  Skipped: $SKIPPED_COUNT domains"
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… All domains deployed successfully!"
          echo ""
          echo "ğŸŒ Deployed domains:"
          find public -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | sed 's/^/  âœ“ /'
        else
          echo "âŒ Deployment encountered issues"
          echo "Check the logs above for details"
        fi
        echo ""