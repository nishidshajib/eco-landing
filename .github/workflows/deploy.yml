name: Deploy All Domains to Hostingername: Deploy All Domains to Hostinger



on:on:

  push:  push:

    branches: [ main ]    branches: [ main ]

  workflow_dispatch:  pull_request:

    branches: [ main ]

jobs:  workflow_dispatch: # Allow manual trigger

  build-and-deploy:

    runs-on: ubuntu-latestjobs:

      build-and-deploy:

    steps:    runs-on: ubuntu-latest

    - name: Checkout repository    

      uses: actions/checkout@v4    steps:

      with:    - name: Checkout repository

        submodules: true      uses: actions/checkout@v4

        fetch-depth: 0      with:

        submodules: true

    - name: Setup Hugo        fetch-depth: 0

      uses: peaceiris/actions-hugo@v2

      with:    - name: Setup Hugo

        hugo-version: 'latest'      uses: peaceiris/actions-hugo@v2

        extended: true      with:

        hugo-version: 'latest'

    - name: Detect Changed Domains        extended: true

      id: changed_domains

      run: |    - name: Detect Changed Domains

        echo "ğŸ” Detecting which domains need to be rebuilt..."      id: changed_domains

              run: |

        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "ALL")        echo "ğŸ” Detecting which domains need to be rebuilt..."

                

        if [ "$CHANGED_FILES" == "ALL" ]; then        # Get list of changed files

          echo "build_all=true" >> $GITHUB_OUTPUT        if [ "${{ github.event_name }}" == "pull_request" ]; then

          echo "âš ï¸ Building ALL domains"          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})

          exit 0        else

        fi          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "ALL")

                fi

        echo "Changed files:"        

        echo "$CHANGED_FILES"        # If no git history or first push, build all

        echo ""        if [ "$CHANGED_FILES" == "ALL" ]; then

                  echo "build_all=true" >> $GITHUB_OUTPUT

        if echo "$CHANGED_FILES" | grep -qE "^(layouts/|themes/|static/|assets/|\.github/workflows/|README)"; then          echo "âš ï¸ Building ALL domains (first push or no history)"

          echo "build_all=true" >> $GITHUB_OUTPUT          exit 0

          echo "âš ï¸ Global files changed - rebuilding ALL domains"        fi

          exit 0        

        fi        echo "Changed files:"

                echo "$CHANGED_FILES"

        DOMAINS=""        echo ""

        for FILE in $CHANGED_FILES; do        

          if [[ "$FILE" =~ ^config/([^/]+)/ ]] || [[ "$FILE" =~ ^content/([^/]+)/ ]]; then        # Check if global files changed (layouts, themes, scripts, workflow)

            DOMAIN="${BASH_REMATCH[1]}"        if echo "$CHANGED_FILES" | grep -qE "^(layouts/|themes/|static/|assets/|scripts/|\.github/workflows/)"; then

            if [ "$DOMAIN" != "_default" ]; then          echo "build_all=true" >> $GITHUB_OUTPUT

              if [[ ! " $DOMAINS " =~ " $DOMAIN " ]]; then          echo "âš ï¸ Global files changed - rebuilding ALL domains"

                DOMAINS="$DOMAINS $DOMAIN"          exit 0

                echo "âœ“ Domain changed: $DOMAIN"        fi

              fi        

            fi        # Find specific domains that changed

          fi        DOMAINS=""

        done        for FILE in $CHANGED_FILES; do

                  # Extract domain name from path: config/DOMAIN/ or content/DOMAIN/

        if [ -z "$DOMAINS" ]; then          if [[ "$FILE" =~ ^config/([^/]+)/ ]] || [[ "$FILE" =~ ^content/([^/]+)/ ]]; then

          echo "build_all=false" >> $GITHUB_OUTPUT            DOMAIN="${BASH_REMATCH[1]}"

        else            # Skip _default

          echo "build_all=false" >> $GITHUB_OUTPUT            if [ "$DOMAIN" != "_default" ]; then

          echo "domains=$DOMAINS" >> $GITHUB_OUTPUT              # Add to list if not already there

        fi              if [[ ! " $DOMAINS " =~ " $DOMAIN " ]]; then

                DOMAINS="$DOMAINS $DOMAIN"

    - name: Build Domains                echo "âœ“ Domain changed: $DOMAIN"

      run: |              fi

        if [ "${{ steps.changed_domains.outputs.build_all }}" == "true" ]; then            fi

          echo "ğŸš€ Building ALL domains..."          fi

                  done

          for CONFIG_DIR in config/*/; do        

            if [[ "$CONFIG_DIR" == *"_default"* ]]; then        if [ -z "$DOMAINS" ]; then

              continue          echo "build_all=false" >> $GITHUB_OUTPUT

            fi          echo "âœ… No domain-specific changes detected"

                    else

            DOMAIN=$(basename "$CONFIG_DIR")          echo "build_all=false" >> $GITHUB_OUTPUT

                      echo "domains=$DOMAINS" >> $GITHUB_OUTPUT

            if [ ! -f "${CONFIG_DIR}hugo.toml" ]; then          echo ""

              continue          echo "ğŸ¯ Domains to build:$DOMAINS"

            fi        fi

            

            echo "ğŸ—ï¸  Building: $DOMAIN"    - name: Build Changed Domains Only

                  run: |

            hugo --environment "$DOMAIN" \        if [ "${{ steps.changed_domains.outputs.build_all }}" == "true" ]; then

                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \          echo "ğŸš€ Building ALL domains..."

                 --destination "public/$DOMAIN" \          

                 --cleanDestinationDir \          # Find and build all domains

                 --minify          for CONFIG_DIR in config/*/; do

                        if [[ "$CONFIG_DIR" == *"_default"* ]]; then

            echo "âœ… $DOMAIN built"              continue

          done            fi

        else            

          DOMAINS="${{ steps.changed_domains.outputs.domains }}"            DOMAIN=$(basename "$CONFIG_DIR")

                      

          if [ -z "$DOMAINS" ]; then            if [ ! -f "${CONFIG_DIR}hugo.toml" ]; then

            echo "âœ… No domains need rebuilding"              echo "âš ï¸  Skipping $DOMAIN - no hugo.toml found"

            exit 0              continue

          fi            fi

                      

          echo "ğŸ¯ Building: $DOMAINS"            echo ""

                      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          for DOMAIN in $DOMAINS; do            echo "ğŸ—ï¸  Building: $DOMAIN"

            echo "ğŸ—ï¸  Building: $DOMAIN"            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                        

            hugo --environment "$DOMAIN" \            hugo --environment "$DOMAIN" \

                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \

                 --destination "public/$DOMAIN" \                 --destination "public/$DOMAIN" \

                 --cleanDestinationDir \                 --cleanDestinationDir \

                 --minify                 --minify

                        

            echo "âœ… $DOMAIN built"            echo "âœ… $DOMAIN built successfully"

          done          done

        fi        else

          DOMAINS="${{ steps.changed_domains.outputs.domains }}"

    - name: Deploy to Hostinger          if [ -z "$DOMAINS" ]; then

      run: |            echo "âœ… No domains need rebuilding - skipping"

        echo "ğŸš€ Deploying to Hostinger..."            exit 0

                  fi

        sudo apt-get update -qq && sudo apt-get install -y lftp          

                  echo "ğŸ¯ Building only changed domains: $DOMAINS"

        DEPLOYED=0          for DOMAIN in $DOMAINS; do

                    echo ""

        for DOMAIN_DIR in public/*/; do            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ ! -d "$DOMAIN_DIR" ]; then            echo "ğŸ—ï¸  Building: $DOMAIN"

            continue            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          fi            

                      hugo --environment "$DOMAIN" \

          DOMAIN_NAME=$(basename "$DOMAIN_DIR")                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \

          CONFIG_FILE="config/${DOMAIN_NAME}/hugo.toml"                 --destination "public/$DOMAIN" \

                           --cleanDestinationDir \

          if [ ! -f "$CONFIG_FILE" ]; then                 --minify

            continue            

          fi            echo "âœ… $DOMAIN built successfully"

                    done

          BASE_URL=$(grep -E "^baseURL" "$CONFIG_FILE" | head -1 | sed -E 's/^baseURL[[:space:]]*=[[:space:]]*["\x27]([^"\x27]+)["\x27].*/\1/')        fi

          CLEAN_DOMAIN=$(echo "$BASE_URL" | sed 's|https\?://||' | sed 's|www\.||' | sed 's|/.*||')    

              # Deploy ALL domains dynamically - no hardcoded domain names!

          if [ -z "$CLEAN_DOMAIN" ]; then    # Automatically discovers and deploys any domain in public/ folder

            continue

          fi    - name: Deploy All Built Domains via FTP

                run: |

          echo ""        echo "ğŸš€ Starting dynamic FTP deployment..."

          echo "ğŸ“¤ Deploying: $DOMAIN_NAME â†’ $CLEAN_DOMAIN"        echo ""

                  

          lftp -e "        # Install lftp for reliable FTP uploads

            set ssl:verify-certificate no;        sudo apt-get update && sudo apt-get install -y lftp

            set net:timeout 30;        

            set net:max-retries 2;        DEPLOYED_COUNT=0

            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};        SKIPPED_COUNT=0

            mirror -Rev --delete --parallel=4 ${DOMAIN_DIR} /domains/${CLEAN_DOMAIN}/public_html/;        

            bye        # Loop through all folders in public/

          "        for DOMAIN_DIR in public/*/; do

                    if [ ! -d "$DOMAIN_DIR" ]; then

          if [ $? -eq 0 ]; then            continue

            echo "âœ… $DOMAIN_NAME deployed"          fi

            DEPLOYED=$((DEPLOYED + 1))          

          else          DOMAIN_NAME=$(basename "$DOMAIN_DIR")

            echo "âŒ $DOMAIN_NAME failed"          

            exit 1          # Skip non-domain directories (build artifacts)

          fi          if [[ "$DOMAIN_NAME" == "blogs" ]] || [[ "$DOMAIN_NAME" == "categories" ]] || \

        done             [[ "$DOMAIN_NAME" == "tags" ]] || [[ "$DOMAIN_NAME" == "page" ]]; then

                    echo "â­ï¸  Skipping artifact directory: $DOMAIN_NAME"

        echo ""            continue

        echo "âœ… Deployed $DEPLOYED domains"          fi

          
          # Get domain URL from config
          CONFIG_FILE="config/${DOMAIN_NAME}/hugo.toml"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âš ï¸  Skipping $DOMAIN_NAME - no config found"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          # Extract baseURL
          BASE_URL=$(grep -E "^baseURL" "$CONFIG_FILE" | head -1 | sed -E 's/^baseURL[[:space:]]*=[[:space:]]*["\x27]([^"\x27]+)["\x27].*/\1/')
          CLEAN_DOMAIN=$(echo "$BASE_URL" | sed 's|https\?://||' | sed 's|www\.||' | sed 's|/.*||')
          
          if [ -z "$CLEAN_DOMAIN" ]; then
            echo "âš ï¸  Skipping $DOMAIN_NAME - could not extract domain"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            continue
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ Deploying: $DOMAIN_NAME"
          echo "ğŸŒ Domain: $CLEAN_DOMAIN"
          echo "ğŸ“‚ Local: $DOMAIN_DIR"
          echo "ğŸ“ Remote: /domains/${CLEAN_DOMAIN}/public_html/"
          
          # FTP upload using lftp (handles large deployments efficiently)
          lftp -e "
            set ssl:verify-certificate no;
            set net:timeout 30;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
            mirror -Rev --delete --parallel=4 --exclude .git/ --exclude node_modules/ ${DOMAIN_DIR} /domains/${CLEAN_DOMAIN}/public_html/;
            bye
          " 2>&1
          
          if [ $? -eq 0 ]; then
            echo "âœ… $DOMAIN_NAME deployed successfully"
            DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
          else
            echo "âŒ $DOMAIN_NAME deployment failed"
          fi
          echo ""
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Complete"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Deployed: $DEPLOYED_COUNT domains"
        if [ $SKIPPED_COUNT -gt 0 ]; then
          echo "âš ï¸  Skipped: $SKIPPED_COUNT domains"
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… All domains deployed successfully!"
          echo ""
          echo "ğŸŒ Deployed domains:"
          find public -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | sed 's/^/  âœ“ /'
        else
          echo "âŒ Deployment encountered issues"
          echo "Check the logs above for details"
        fi
        echo ""