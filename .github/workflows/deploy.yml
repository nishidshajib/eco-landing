name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true
    - name: Build All
      run: |
        for d in config/*/; do
          [[ $d == *"_default"* ]] && continue
          domain=$(basename $d)
          [[ ! -f $d/hugo.toml ]] && continue
          echo "Building $domain"
          hugo --environment $domain --config config/_default/hugo.toml,$d/hugo.toml --destination public/$domain --cleanDestinationDir --minify
        done
    - name: Deploy
      run: |
        sudo apt-get update -qq && sudo apt-get install -y lftp
        
        for d in public/*/; do
          domain=$(basename $d)
          cfg=config/$domain/hugo.toml
          [[ ! -f $cfg ]] && continue
          
          url=$(grep baseURL $cfg | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
          clean=$(echo $url | sed 's|https\?://||;s|www\.||;s|/.*||')
          
          echo "Deploying $domain to $clean"
          
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" -e "set ssl:verify-certificate no; set ftp:ssl-allow yes; set net:timeout 10; set net:max-retries 2; set net:reconnect-interval-base 5; mirror -Rev --delete --verbose --parallel=2 $d /domains/$clean/public_html/; bye" "${{ secrets.FTP_SERVER }}"
        done
