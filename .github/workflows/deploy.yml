name: Deploy All Domains to Hostinger

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Detect Changed Domains
      id: changed_domains
      run: |
        echo "ğŸ” Detecting which domains need to be rebuilt..."
        
        # Get list of changed files
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
        else
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "ALL")
        fi
        
        # If no git history or first push, build all
        if [ "$CHANGED_FILES" == "ALL" ]; then
          echo "build_all=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Building ALL domains (first push or no history)"
          exit 0
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo ""
        
        # Check if global files changed (layouts, themes, scripts, workflow)
        if echo "$CHANGED_FILES" | grep -qE "^(layouts/|themes/|static/|assets/|scripts/|\.github/workflows/)"; then
          echo "build_all=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Global files changed - rebuilding ALL domains"
          exit 0
        fi
        
        # Find specific domains that changed
        DOMAINS=""
        for FILE in $CHANGED_FILES; do
          # Extract domain name from path: config/DOMAIN/ or content/DOMAIN/
          if [[ "$FILE" =~ ^config/([^/]+)/ ]] || [[ "$FILE" =~ ^content/([^/]+)/ ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            # Skip _default
            if [ "$DOMAIN" != "_default" ]; then
              # Add to list if not already there
              if [[ ! " $DOMAINS " =~ " $DOMAIN " ]]; then
                DOMAINS="$DOMAINS $DOMAIN"
                echo "âœ“ Domain changed: $DOMAIN"
              fi
            fi
          fi
        done
        
        if [ -z "$DOMAINS" ]; then
          echo "build_all=false" >> $GITHUB_OUTPUT
          echo "âœ… No domain-specific changes detected"
        else
          echo "build_all=false" >> $GITHUB_OUTPUT
          echo "domains=$DOMAINS" >> $GITHUB_OUTPUT
          echo ""
          echo "ğŸ¯ Domains to build:$DOMAINS"
        fi

    - name: Build Changed Domains Only
      run: |
        if [ "${{ steps.changed_domains.outputs.build_all }}" == "true" ]; then
          echo "ğŸš€ Building ALL domains..."
          bash scripts/build-all-domains.sh
        else
          DOMAINS="${{ steps.changed_domains.outputs.domains }}"
          if [ -z "$DOMAINS" ]; then
            echo "âœ… No domains need rebuilding - skipping"
            exit 0
          fi
          
          echo "ğŸ¯ Building only changed domains: $DOMAINS"
          for DOMAIN in $DOMAINS; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ—ï¸  Building: $DOMAIN"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            hugo --environment "$DOMAIN" \
                 --config "config/_default/hugo.toml,config/$DOMAIN/hugo.toml" \
                 --destination "public/$DOMAIN" \
                 --cleanDestinationDir \
                 --minify
            
            echo "âœ… $DOMAIN built successfully"
          done
        fi
    
    # Deploy only the domains that were built
    # Each domain deployment checks if its folder exists in public/

    - name: Deploy badcreditloanspecialist
      if: hashFiles('public/badcreditloanspecialist/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/badcreditloanspecialist/
        server-dir: /domains/badcreditloanspecialist.com/public_html/
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conformingmortgageloans
      if: hashFiles('public/conformingmortgageloans/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conformingmortgageloans/
        server-dir: /domains/conformingmortgageloans.com/public_html/
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conventionalmortgagebrokers
      if: hashFiles('public/conventionalmortgagebrokers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgagebrokers/
        server-dir: ${{ secrets.CONVENTIONALMORTGAGEBROKERS_FTP_DIR || '/domains/conventionalmortgagebrokers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conventionalmortgageloans
      if: hashFiles('public/conventionalmortgageloans/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgageloans/
        server-dir: ${{ secrets.CONVENTIONALMORTGAGELOANS_FTP_DIR || '/domains/conventionalmortgageloans.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy fhaloanofficers
      if: hashFiles('public/fhaloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/fhaloanofficers/
        server-dir: ${{ secrets.FHALOANOFFICERS_FTP_DIR || '/domains/fhaloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy firsttimebuyeroptions
      if: hashFiles('public/firsttimebuyeroptions/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/firsttimebuyeroptions/
        server-dir: ${{ secrets.FIRSTTIMEBUYEROPTIONS_FTP_DIR || '/domains/firsttimebuyeroptions.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy helocloanofficers
      if: hashFiles('public/helocloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/helocloanofficers/
        server-dir: ${{ secrets.HELOCLOANOFFICERS_FTP_DIR || '/domains/helocloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy mtglenders
      if: hashFiles('public/mtglenders/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/mtglenders/
        server-dir: ${{ secrets.MTGLENDERS_FTP_DIR || '/domains/mtglenders.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy refimortgagebrokers
      if: hashFiles('public/refimortgagebrokers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/refimortgagebrokers/
        server-dir: ${{ secrets.REFIMORTGAGEBROKERS_FTP_DIR || '/domains/refimortgagebrokers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy refinanceloanofficers
      if: hashFiles('public/refinanceloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/refinanceloanofficers/
        server-dir: ${{ secrets.REFINANCELOANOFFICERS_FTP_DIR || '/domains/refinanceloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy veteransloanofficers
      if: hashFiles('public/veteransloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/veteransloanofficers/
        server-dir: ${{ secrets.VETERANSLOANOFFICERS_FTP_DIR || '/domains/veteransloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… All domains deployed successfully!"
          echo ""
          echo "ğŸŒ Deployed domains:"
          find public -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | sed 's/^/  âœ“ /'
        else
          echo "âŒ Deployment encountered issues"
          echo "Check the logs above for details"
        fi
        echo ""