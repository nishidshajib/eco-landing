name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true
    - name: Build All
      run: |
        for d in config/*/; do
          [[ $d == *"_default"* ]] && continue
          domain=$(basename $d)
          [[ ! -f $d/hugo.toml ]] && continue
          echo "Building $domain"
          hugo --environment $domain --config config/_default/hugo.toml,$d/hugo.toml --destination public/$domain --cleanDestinationDir --minify
        done
    - name: Deploy
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        sudo apt-get update -qq && sudo apt-get install -y lftp
        
        for d in public/*/; do
          domain=$(basename $d)
          cfg=config/$domain/hugo.toml
          [[ ! -f $cfg ]] && continue
          
          url=$(grep baseURL $cfg | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
          clean=$(echo $url | sed 's|https\?://||;s|www\.||;s|/.*||')
          
          echo "Deploying $domain to $clean"
          
          lftp -c "
            set ssl:verify-certificate no
            open -u $FTP_USER,$FTP_PASS $FTP_HOST
            mirror -Rev --delete --parallel=4 $d /domains/$clean/public_html/
            bye
          "
        done
