name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true
    
    - name: Detect Changed Domains
      id: changes
      run: |
        if [ "${{ github.event_name }}" == "schedule" ]; then
          # Scheduled run: build all domains (Hugo filters future posts automatically)
          echo "Scheduled run - building all domains"
          CHANGED_DOMAINS="all"
        else
          # Push event: detect what changed
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          
          # If layouts or themes changed, rebuild all (affects all domains)
          if echo "$CHANGED_FILES" | grep -qE '(^layouts/|^themes/)'; then
            echo "Layouts or themes changed - rebuilding all domains"
            CHANGED_DOMAINS="all"
          # If workflow changed, rebuild all
          elif echo "$CHANGED_FILES" | grep -q "\.github/workflows/"; then
            echo "Workflow changed - rebuilding all domains"
            CHANGED_DOMAINS="all"
          else
            # Only content or config changed - build specific domains
            CHANGED_DOMAINS=$(echo "$CHANGED_FILES" | grep -E '^(content|config)/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
            
            # If no specific domains changed, skip build
            if [ -z "$CHANGED_DOMAINS" ]; then
              echo "No domain changes detected"
              CHANGED_DOMAINS="none"
            else
              echo "Building only changed domains: $CHANGED_DOMAINS"
            fi
          fi
        fi
        
        echo "changed_domains=$CHANGED_DOMAINS" >> $GITHUB_OUTPUT
        echo "Strategy: $CHANGED_DOMAINS"
    
    - name: Build Changed Domains
      run: |
        DOMAINS="${{ steps.changes.outputs.changed_domains }}"
        
        if [ "$DOMAINS" == "none" ]; then
          echo "No domains to build"
          exit 0
        fi
        
        if [ "$DOMAINS" == "all" ]; then
          echo "Building all domains"
          for d in config/*/; do
            [[ $d == *"_default"* ]] && continue
            domain=$(basename $d)
            [[ ! -f $d/hugo.toml ]] && continue
            echo "Building $domain"
            hugo --environment $domain --config config/_default/hugo.toml,$d/hugo.toml --destination public/$domain --cleanDestinationDir --minify
          done
        else
          echo "Building changed domains only"
          for domain in $DOMAINS; do
            [[ ! -f config/$domain/hugo.toml ]] && continue
            echo "Building $domain"
            hugo --environment $domain --config config/_default/hugo.toml,config/$domain/hugo.toml --destination public/$domain --cleanDestinationDir --minify
          done
        fi
    
    - name: Deploy Changed Domains
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        DOMAINS="${{ steps.changes.outputs.changed_domains }}"
        
        if [ "$DOMAINS" == "none" ]; then
          echo "No domains to deploy"
          exit 0
        fi
        
        sudo apt-get update -qq && sudo apt-get install -y lftp
        
        # Create .netrc file to handle credentials securely (avoids special character issues)
        printf "machine %s\nlogin %s\npassword %s\n" "$FTP_HOST" "$FTP_USER" "$FTP_PASS" > ~/.netrc
        chmod 600 ~/.netrc
        
        if [ "$DOMAINS" == "all" ]; then
          DEPLOY_LIST=$(ls -d public/*/ 2>/dev/null | xargs -n1 basename)
        else
          DEPLOY_LIST="$DOMAINS"
        fi
        
        for domain in $DEPLOY_LIST; do
          [[ ! -d public/$domain ]] && continue
          cfg=config/$domain/hugo.toml
          [[ ! -f $cfg ]] && continue
          
          url=$(grep baseURL $cfg | head -1 | sed -E 's/.*["\x27]([^"\x27]+)["\x27].*/\1/')
          clean=$(echo $url | sed 's|https\?://||;s|www\.||;s|/.*||')
          
          echo "Deploying $domain to $clean"
          
          # Upload folder contents (not folder itself) with --delete-first to remove old files safely
          # --delete-first: delete files before transferring (safer, doesn't fail on missing files)
          # --only-newer: only upload files that are newer
          # --ignore-time: ignore time when deciding which files to upload
          # Credentials read automatically from ~/.netrc
          lftp -c "set ssl:verify-certificate no; set ftp:ssl-allow yes; set net:timeout 10; set net:max-retries 2; set ftp:use-feat no; open $FTP_HOST; mirror -Rev --delete-first --only-newer --parallel=2 --verbose=0 public/$domain/ /domains/$clean/public_html/ || echo 'Deployment completed with warnings'; bye"
        done
        
        # Clean up credentials file
        rm -f ~/.netrc
