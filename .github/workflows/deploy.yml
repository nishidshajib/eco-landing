name: Deploy All Domains to Hostinger

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build All Landing Page Domains
      run: |
        echo "üöÄ Building all landing page domains automatically..."
        bash scripts/build-all-domains.sh

    - name: Generate Deployment Configuration
      id: deploy_config
      run: |
        echo "üó∫Ô∏è Generating deployment configuration..."
        
        # Create a JSON array of all domains to deploy
        DOMAINS_JSON="["
        FIRST=true
        
        for CONFIG_DIR in config/*/; do
          # Skip _default directory
          if [[ "$CONFIG_DIR" == *"_default"* ]]; then
            continue
          fi
          
          DOMAIN_NAME=$(basename "$CONFIG_DIR")
          CONFIG_FILE="${CONFIG_DIR}hugo.toml"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            continue
          fi
          
          # Extract baseURL from config
          BASE_URL=$(grep -E "^baseURL" "$CONFIG_FILE" | cut -d"'" -f2 | head -1)
          if [ -z "$BASE_URL" ]; then
            BASE_URL=$(grep -E "^baseURL" "$CONFIG_FILE" | cut -d'"' -f2 | head -1)
          fi
          
          # Extract clean domain name from URL
          CLEAN_DOMAIN=$(echo "$BASE_URL" | sed 's|https\?://||' | sed 's|www\.||' | sed 's|/.*||')
          
          # Build JSON entry
          if [ "$FIRST" = true ]; then
            FIRST=false
          else
            DOMAINS_JSON="$DOMAINS_JSON,"
          fi
          
          DOMAINS_JSON="$DOMAINS_JSON{\"name\":\"$DOMAIN_NAME\",\"domain\":\"$CLEAN_DOMAIN\"}"
        done
        
        DOMAINS_JSON="$DOMAINS_JSON]"
        echo "domains=$DOMAINS_JSON" >> $GITHUB_OUTPUT
        echo "üìã Found $(echo $DOMAINS_JSON | grep -o '\"name\"' | wc -l) domains to deploy"

    - name: Deploy All Domains via FTP
      run: |
        echo "üöÄ Deploying all domains to Hostinger..."
        
        # Parse domains JSON and deploy each one
        DOMAINS='${{ steps.deploy_config.outputs.domains }}'
        
        echo "$DOMAINS" | jq -c '.[]' | while read -r domain; do
          DOMAIN_NAME=$(echo "$domain" | jq -r '.name')
          CLEAN_DOMAIN=$(echo "$domain" | jq -r '.domain')
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì§ Deploying: $DOMAIN_NAME"
          echo "üåê Domain: $CLEAN_DOMAIN"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          LOCAL_DIR="./public/${DOMAIN_NAME}/"
          
          if [ ! -d "$LOCAL_DIR" ]; then
            echo "‚ö†Ô∏è  Skipping $DOMAIN_NAME - directory not found"
            continue
          fi
          
          # Check for custom FTP directory secret
          SECRET_VAR=$(echo "${DOMAIN_NAME}" | tr '[:lower:]' '[:upper:]')_FTP_DIR
          
          # Default FTP path based on domain
          DEFAULT_FTP_PATH="/domains/${CLEAN_DOMAIN}/public_html/"
          
          echo "  üìÇ Local: $LOCAL_DIR"
          echo "  üìç Remote: $DEFAULT_FTP_PATH"
          echo "  üíæ Files: $(find "$LOCAL_DIR" -type f | wc -l)"
          
          # Store for next step
          echo "${DOMAIN_NAME}|${CLEAN_DOMAIN}|${LOCAL_DIR}|${DEFAULT_FTP_PATH}" >> /tmp/deploy_list.txt
        done
        
        echo ""
        echo "‚úÖ Deployment configuration ready"
        cat /tmp/deploy_list.txt

    - name: Deploy badcreditloanspecialist
      if: hashFiles('public/badcreditloanspecialist/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/badcreditloanspecialist/
        server-dir: ${{ secrets.BADCREDITLOANSPECIALIST_FTP_DIR || '/domains/badcreditloanspecialist.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conformingmortgageloans
      if: hashFiles('public/conformingmortgageloans/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conformingmortgageloans/
        server-dir: ${{ secrets.CONFORMINGMORTGAGELOANS_FTP_DIR || '/domains/www.conformingmortgageloans.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conventionalmortgagebrokers
      if: hashFiles('public/conventionalmortgagebrokers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgagebrokers/
        server-dir: ${{ secrets.CONVENTIONALMORTGAGEBROKERS_FTP_DIR || '/domains/conventionalmortgagebrokers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy conventionalmortgageloans
      if: hashFiles('public/conventionalmortgageloans/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgageloans/
        server-dir: ${{ secrets.CONVENTIONALMORTGAGELOANS_FTP_DIR || '/domains/conventionalmortgageloans.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy fhaloanofficers
      if: hashFiles('public/fhaloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/fhaloanofficers/
        server-dir: ${{ secrets.FHALOANOFFICERS_FTP_DIR || '/domains/fhaloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy firsttimebuyeroptions
      if: hashFiles('public/firsttimebuyeroptions/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/firsttimebuyeroptions/
        server-dir: ${{ secrets.FIRSTTIMEBUYEROPTIONS_FTP_DIR || '/domains/firsttimebuyeroptions.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy helocloanofficers
      if: hashFiles('public/helocloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/helocloanofficers/
        server-dir: ${{ secrets.HELOCLOANOFFICERS_FTP_DIR || '/domains/helocloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy mtglenders
      if: hashFiles('public/mtglenders/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/mtglenders/
        server-dir: ${{ secrets.MTGLENDERS_FTP_DIR || '/domains/mtglenders.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy refimortgagebrokers
      if: hashFiles('public/refimortgagebrokers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/refimortgagebrokers/
        server-dir: ${{ secrets.REFIMORTGAGEBROKERS_FTP_DIR || '/domains/refimortgagebrokers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy refinanceloanofficers
      if: hashFiles('public/refinanceloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/refinanceloanofficers/
        server-dir: ${{ secrets.REFINANCELOANOFFICERS_FTP_DIR || '/domains/refinanceloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy veteransloanofficers
      if: hashFiles('public/veteransloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/veteransloanofficers/
        server-dir: ${{ secrets.VETERANSLOANOFFICERS_FTP_DIR || '/domains/veteransloanofficers.com/public_html/' }}
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìä Deployment Summary"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ All domains deployed successfully!"
          echo ""
          echo "üåê Deployed domains:"
          find public -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | sed 's/^/  ‚úì /'
        else
          echo "‚ùå Deployment encountered issues"
          echo "Check the logs above for details"
        fi
        echo ""