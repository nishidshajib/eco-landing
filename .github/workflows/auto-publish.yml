name: Auto-Publish Scheduled Posts

on:
  schedule:
    # Run every hour to check for posts ready to publish
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'content/**/blogs/**/*.md'
      - 'content/**/*.md'

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check and Update Scheduled Posts
      id: check_posts
      run: |
        echo "üïê Checking for posts ready to publish..."
        
        # Create script to check publishdate
        cat > check_posts.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const { execSync } = require('child_process');
        
        function parseDate(dateStr) {
          if (!dateStr) return null;
          return new Date(dateStr);
        }
        
        function updatePostStatus(filePath, content) {
          // Remove draft: true if it exists
          const updatedContent = content
            .replace(/^draft\s*:\s*true\s*$/gm, 'draft: false')
            .replace(/^draft\s*=\s*true\s*$/gm, 'draft = false');
          
          if (updatedContent !== content) {
            fs.writeFileSync(filePath, updatedContent);
            console.log(`‚úÖ Published: ${filePath}`);
            return true;
          }
          return false;
        }
        
        function processDirectory(dir) {
          let hasChanges = false;
          
          if (!fs.existsSync(dir)) return hasChanges;
          
          const files = fs.readdirSync(dir, { withFileTypes: true });
          
          for (const file of files) {
            const fullPath = path.join(dir, file.name);
            
            if (file.isDirectory()) {
              hasChanges = processDirectory(fullPath) || hasChanges;
            } else if (file.name.endsWith('.md')) {
              try {
                const content = fs.readFileSync(fullPath, 'utf8');
                
                // Extract front matter
                const frontMatterMatch = content.match(/^---\s*\n([\s\S]*?)\n---/);
                if (!frontMatterMatch) continue;
                
                const frontMatter = frontMatterMatch[1];
                
                // Check if post is draft
                const isDraft = /^draft\s*:\s*true/gm.test(frontMatter) || 
                               /^draft\s*=\s*true/gm.test(frontMatter);
                
                if (!isDraft) continue;
                
                // Extract publishdate
                const publishDateMatch = frontMatter.match(/^publishdate\s*[:=]\s*['"]?([^'"\\n]+)['"]?/gm);
                if (!publishDateMatch) continue;
                
                const publishDateStr = publishDateMatch[0].split(/[:=]/)[1].trim().replace(/['"]/g, '');
                const publishDate = parseDate(publishDateStr);
                const now = new Date();
                
                console.log(`üìÖ Checking ${fullPath}:`);
                console.log(`   Publish Date: ${publishDate}`);
                console.log(`   Current Time: ${now}`);
                
                if (publishDate && publishDate <= now) {
                  console.log(`üöÄ Ready to publish: ${fullPath}`);
                  if (updatePostStatus(fullPath, content)) {
                    hasChanges = true;
                  }
                } else {
                  console.log(`‚è≥ Not yet ready: ${fullPath}`);
                }
                
              } catch (error) {
                console.log(`‚ùå Error processing ${fullPath}: ${error.message}`);
              }
            }
          }
          
          return hasChanges;
        }
        
        // Process all content directories
        const contentDirs = [
          'content',
          'content/conventionalmortgagebrokers/blogs',
          'content/conventionalmortgageloans/blogs', 
          'content/helocloanofficers/blogs'
        ];
        
        let totalChanges = false;
        
        for (const dir of contentDirs) {
          console.log(`\\nüìÇ Processing directory: ${dir}`);
          totalChanges = processDirectory(dir) || totalChanges;
        }
        
        if (totalChanges) {
          console.log('\\n‚ú® Posts were published! Proceeding with deployment...');
          process.exit(0);
        } else {
          console.log('\\nüò¥ No posts ready to publish at this time.');
          process.exit(1);
        }
        EOF
        
        # Run the post checker
        if node check_posts.js; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "üéâ Found posts to publish!"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "üí§ No posts to publish right now."
        fi

    - name: Commit Published Posts
      if: steps.check_posts.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "üöÄ Auto-publish scheduled posts - $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
        git push

    - name: Build Sites with Published Posts
      if: steps.check_posts.outputs.has_changes == 'true'
      run: |
        echo "üèóÔ∏è Building sites with newly published posts..."
        
        # Build each site configuration
        if [ -f "config/conventionalmortgagebrokers/hugo.toml" ]; then
          echo "Building Conventional Mortgage Brokers site..."
          hugo --config config/conventionalmortgagebrokers/hugo.toml --minify --destination "public/conventionalmortgagebrokers"
        fi
        
        if [ -f "config/conventionalmortgageloans/hugo.toml" ]; then
          echo "Building Conventional Mortgage Loans site..."
          hugo --config config/conventionalmortgageloans/hugo.toml --minify --destination "public/conventionalmortgageloans"
        fi
        
        if [ -f "config/helocloanofficers/hugo.toml" ]; then
          echo "Building HELOC Loan Officers site..."
          hugo --config config/helocloanofficers/hugo.toml --minify --destination "public/helocloanofficers"
        fi
        
        echo "üìä Built sites summary:"
        find public -name "*.html" | wc -l && echo "HTML files generated"

    - name: Deploy Published Posts to Hostinger
      if: steps.check_posts.outputs.has_changes == 'true'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/
        server-dir: /public_html/
        exclude: |
          **/.git*
          **/node_modules/**

    - name: Deploy to Individual Domains
      if: steps.check_posts.outputs.has_changes == 'true'
      run: |
        # Deploy each site to its respective domain
        
        if [ -d "public/conventionalmortgagebrokers" ]; then
          echo "üöÄ Deploying Brokers site..."
          # This will be handled by separate deploy steps below
        fi
        
        if [ -d "public/conventionalmortgageloans" ]; then
          echo "üöÄ Deploying Loans site..."
        fi
        
        if [ -d "public/helocloanofficers" ]; then
          echo "üöÄ Deploying HELOC site..."
        fi

    - name: Deploy Brokers Site
      if: steps.check_posts.outputs.has_changes == 'true' && hashFiles('public/conventionalmortgagebrokers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgagebrokers/
        server-dir: ${{ secrets.BROKERS_FTP_DIR || '/domains/conventionalmortgagebrokers.com/public_html/' }}

    - name: Deploy Loans Site
      if: steps.check_posts.outputs.has_changes == 'true' && hashFiles('public/conventionalmortgageloans/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/conventionalmortgageloans/
        server-dir: ${{ secrets.LOANS_FTP_DIR || '/domains/conventionalmortgageloans.com/public_html/' }}

    - name: Deploy HELOC Site
      if: steps.check_posts.outputs.has_changes == 'true' && hashFiles('public/helocloanofficers/**') != ''
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./public/helocloanofficers/
        server-dir: ${{ secrets.HELOC_FTP_DIR || '/domains/helocloanofficers.com/public_html/' }}

    - name: Send Notification
      if: steps.check_posts.outputs.has_changes == 'true'
      run: |
        echo "üìß Posts published and deployed successfully!"
        echo "üïê Published at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        
        # Count published posts
        published_count=$(git log -1 --name-only --pretty=format: | grep -c "\.md$" || echo "0")
        echo "üìù Number of posts published: $published_count"